!function(){"use strict";function t(t,r){r=r||{};var s=r.filters;t.filters=s?n.isArray(s)?s:[s]:[];for(var a=0;a<t.filters.length;a++){var o=t.filters[a];if(!o.processors)throw new Error("Filter processors must be specified.");o.processors=n.isArray(o.processors)?o.processors:[o.processors]}if(t.filterIncrement++,"sync"===r.loadMode)t.viewer.forceRedraw();else{for(var h=[],a=0;a<t.filters.length;a++){var o=t.filters[a];if(!o.items){h=i(t.viewer.world);break}if(n.isArray(o.items))for(var l=0;l<o.items.length;l++)e(o.items[l],h);else e(o.items,h)}for(var a=0;a<h.length;a++)h[a].reset()}}function e(t,e){if(e.indexOf(t)>=0)throw new Error("An item can not have filters assigned multiple times.");e.push(t)}function i(t){for(var e=[],i=0;i<t.getItemCount();i++)e.push(t.getItemAt(i));return e}function r(t,e){if(0===t.filters.length)return[];for(var i=null,r=0;r<t.filters.length;r++){var s=t.filters[r];if(s.items){if(s.items===e||n.isArray(s.items)&&s.items.indexOf(e)>=0)return s.processors}else i=s.processors}return i?i:[]}var n=window.OpenSeadragon;if(!n&&(n=require("openseadragon"),!n))throw new Error("OpenSeadragon is missing.");if(!n.version||n.version.major<2||2===n.version.major&&n.version.minor<1)throw new Error("Filtering plugin requires OpenSeadragon version >= 2.1");n.Viewer.prototype.setFilterOptions=function(e){this.filterPluginInstance?t(this.filterPluginInstance,e):(e=e||{},e.viewer=this,this.filterPluginInstance=new n.FilterPlugin(e))},n.FilterPlugin=function(e){function i(t){var e=r(a,t.tiledImage);if(0!==e.length){var i=t.tile,s=t.image;if(null!==s){var o=window.document.createElement("canvas");o.width=s.width,o.height=s.height;var h=o.getContext("2d");h.drawImage(s,0,0),i._renderedContext=h;var l=t.getCompletionCallback();n(h,e,l),i._filterIncrement=a.filterIncrement}}}function n(t,e,i){if(i){for(var r=a.filterIncrement,n=[],s=0;s<e.length-1;s++)!function(i){n[i]=function(){a.filterIncrement===r&&e[i+1](t,n[i+1])}}(s);n[e.length-1]=function(){a.filterIncrement===r&&i()},e[0](t,n[0])}else for(var s=0;s<e.length;s++)e[s](t,function(){})}function s(t){var e=t.tile,i=t.rendered;if(i._filterIncrement!==a.filterIncrement){var s=r(a,t.tiledImage);if(0===s.length)return i._originalImageData&&(i.putImageData(i._originalImageData,0,0),delete i._originalImageData),void(i._filterIncrement=a.filterIncrement);if(i._originalImageData?i.putImageData(i._originalImageData,0,0):i._originalImageData=i.getImageData(0,0,i.canvas.width,i.canvas.height),e._renderedContext){if(e._filterIncrement===a.filterIncrement){var o=e._renderedContext.getImageData(0,0,e._renderedContext.canvas.width,e._renderedContext.canvas.height);return i.putImageData(o,0,0),delete e._renderedContext,delete e._filterIncrement,void(i._filterIncrement=a.filterIncrement)}delete e._renderedContext,delete e._filterIncrement}n(i,s),i._filterIncrement=a.filterIncrement}}if(e=e||{},!e.viewer)throw new Error("A viewer must be specified.");var a=this;this.viewer=e.viewer,this.viewer.addHandler("tile-loaded",i),this.viewer.addHandler("tile-drawing",s),this.filterIncrement=0,t(this,e)},n.Filters={THRESHOLDING:function(t){if(t<-1||t>255)throw new Error("Threshold must be between 0 and 255.");return function(e,i){var r=e.getImageData(0,0,e.canvas.width,e.canvas.height),n=r.data;if(t>-1)for(var s=0;s<n.length;s+=4){var a=n[s],o=n[s+1],h=n[s+2],l=(a+o+h)/3;n[s]=n[s+1]=n[s+2]=l<t?0:255}e.putImageData(r,0,0),i()}},BRIGHTNESS:function(t){if(t<-255||t>255)throw new Error("Brightness adjustment must be between -255 and 255.");return function(e,i){for(var r=e.getImageData(0,0,e.canvas.width,e.canvas.height),n=r.data,s=0;s<n.length;s+=4)n[s]+=t,n[s+1]+=t,n[s+2]+=t;e.putImageData(r,0,0),i()}},CONTRAST:function(t){if(t<0)throw new Error("Contrast adjustment must be positive.");return function(e,i){for(var r=e.getImageData(0,0,e.canvas.width,e.canvas.height),n=r.data,s=0;s<n.length;s+=4)n[s]*=t,n[s+1]*=t,n[s+2]*=t;e.putImageData(r,0,0),i()}},GAMMA:function(t){if(t<0)throw new Error("Gamma adjustment must be positive.");return function(e,i){for(var r=e.getImageData(0,0,e.canvas.width,e.canvas.height),n=r.data,s=0;s<n.length;s+=4)n[s]=255*Math.pow(n[s]/255,t),n[s+1]=255*Math.pow(n[s+1]/255,t),n[s+2]=255*Math.pow(n[s+2]/255,t);e.putImageData(r,0,0),i()}},GREYSCALE:function(t){return function(e,i){var r=e.getImageData(0,0,e.canvas.width,e.canvas.height),n=r.data;if(t>0)for(var s=0;s<n.length;s+=4){var a=(n[s]+n[s+1]+n[s+2])/3;n[s]=a,n[s+1]=a,n[s+2]=a}e.putImageData(r,0,0),i()}},INVERT:function(t){return function(e,i){var r=e.getImageData(0,0,e.canvas.width,e.canvas.height),n=r.data;if(t>0)for(var s=0;s<n.length;s+=4)n[s]=255-n[s],n[s+1]=255-n[s+1],n[s+2]=255-n[s+2];e.putImageData(r,0,0),i()}},MORPHOLOGICAL_OPERATION:function(t,e){if(t%2===0)throw new Error("The kernel size must be an odd number.");var i=Math.floor(t/2);if(!e)throw new Error("A comparator must be defined.");return function(r,n){for(var s,a=r.canvas.width,o=r.canvas.height,h=r.getImageData(0,0,a,o),l=r.getImageData(0,0,a,o).data,c=0;c<o;c++)for(var u=0;u<a;u++){s=4*(c*a+u);for(var g=l[s],d=l[s+1],p=l[s+2],f=0;f<t;f++)for(var m=0;m<t;m++){var v=u+m-i,b=c+f-i;v>=0&&v<a&&b>=0&&b<o&&(s=4*(b*a+v),g=e(l[s],g),d=e(l[s+1],d),p=e(l[s+2],p))}h.data[s]=g,h.data[s+1]=d,h.data[s+2]=p}r.putImageData(h,0,0),n()}},CONVOLUTION:function(t){if(!n.isArray(t))throw new Error("The kernel must be an array.");var e=Math.sqrt(t.length);if((e+1)%2!==0)throw new Error("The kernel must be a square matrix with oddwidth and height.");var i=(e-1)/2;return function(r,n){for(var s,a=r.canvas.width,o=r.canvas.height,h=r.getImageData(0,0,a,o),l=r.getImageData(0,0,a,o).data,c=0;c<o;c++)for(var u=0;u<a;u++){for(var g=0,d=0,p=0,f=0;f<e;f++)for(var m=0;m<e;m++){var v=u+m-i,b=c+f-i;if(v>=0&&v<a&&b>=0&&b<o){s=4*(b*a+v);var y=t[f*e+m];g+=l[s]*y,d+=l[s+1]*y,p+=l[s+2]*y}}s=4*(c*a+u),h.data[s]=g,h.data[s+1]=d,h.data[s+2]=p}r.putImageData(h,0,0),n()}}}}(),function(){var t,e,i,r,n,s,a,o,h,l,c,u,g,d,p,f,m,v,b,y,x,w,D,I,R,S,C=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1},M=[].slice,P={}.hasOwnProperty,k=function(t,e){return function(){return t.apply(e,arguments)}},F=function(t,e){function i(){this.constructor=t}for(var r in e)P.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};I=["extended","included"],f=function(){function t(){}return t["extends"]=function(t){var e,i,r;for(e in t)i=t[e],C.call(I,e)<0&&(this[e]=i);return null!=(r=t.extended)&&r.apply(this),this},t.includes=function(t){var e,i,r;for(e in t)i=t[e],C.call(I,e)<0&&(this.prototype[e]=i);return null!=(r=t.included)&&r.apply(this),this},t.delegate=function(){var t,e,i,r,n,s;for(t=1<=arguments.length?M.call(arguments,0):[],i=t.pop(),s=[],r=0,n=t.length;r<n;r++)e=t[r],s.push(this.prototype[e]=i.prototype[e]);return s},t.aliasFunction=function(t,e){var i=this;return this.prototype[t]=function(){var t;return t=1<=arguments.length?M.call(arguments,0):[],i.prototype[e].apply(i,t)}},t.aliasProperty=function(t,e){return Object.defineProperty(this.prototype,t,{get:function(){return this[e]},set:function(t){return this[e]=t}})},t.included=function(t){return t.call(this,this.prototype)},t}(),R=Array.prototype.slice,t=function(t,e){return null==e&&(e=document),"object"==typeof t||"undefined"!=typeof exports&&null!==exports?t:e.querySelector(t)},w=function(){function t(){}return t.uniqid=function(){var t;return t=0,{get:function(){return t++}}}(),t.extend=function(){var t,e,i,r,n,s,a;for(i=arguments[0],n=2<=arguments.length?M.call(arguments,1):[],e=i,s=0,a=n.length;s<a;s++){t=n[s];for(r in t)P.call(t,r)&&(e[r]=t[r])}return e},t.clampRGB=function(t){return t<0?0:t>255?255:t},t.copyAttributes=function(t,e,i){var r,n,s,a,o,h;for(null==i&&(i={}),a=t.attributes,h=[],n=0,s=a.length;n<s;n++)r=a[n],null!=i.except&&(o=r.nodeName,C.call(i.except,o)>=0)||h.push(e.setAttribute(r.nodeName,r.nodeValue));return h},t.dataArray=function(t){return null==t&&(t=0),n.NodeJS||null!=window.Uint8Array?new Uint8Array(t):new Array(t)},t}(),"undefined"!=typeof exports&&null!==exports?(y=exports,a=require("canvas"),g=a.Image,l=require("fibers"),D=require("fs")):y=window,n=function(i){function r(){this.nodeFileReady=k(this.nodeFileReady,this);var t,i,n,s=this;if(0===arguments.length)throw"Invalid arguments";return this instanceof r?(this.finishInit=this.finishInit.bind(this),this.imageLoaded=this.imageLoaded.bind(this),t=arguments[0],r.NodeJS||(n=parseInt(r.getAttrId(t[0]),10),i="function"==typeof t[1]?t[1]:"function"==typeof t[2]?t[2]:function(){},isNaN(n)||!x.has(n))?(this.id=w.uniqid.get(),this.initializedPixelData=this.originalPixelData=null,this.cropCoordinates={x:0,y:0},this.cropped=!1,this.resized=!1,this.pixelStack=[],this.layerStack=[],this.canvasQueue=[],this.currentLayer=null,this.scaled=!1,this.analyze=new e(this),this.renderer=new b(this),this.domIsLoaded(function(){return s.parseArguments(t),s.setup()}),this):x.execute(n,i)):new r(arguments)}return F(r,i),r.version={release:"4.1.2",date:"7/27/2013"},r.DEBUG=!1,r.allowRevert=!0,r.crossOrigin="anonymous",r.remoteProxy="",r.proxyParam="camanProxyUrl",r.NodeJS="undefined"!=typeof exports&&null!==exports,r.autoload=!r.NodeJS,r.toString=function(){return"Version "+r.version.release+", Released "+r.version.date},r.getAttrId=function(e){return!!r.NodeJS||("string"==typeof e&&(e=t(e)),null==e||null==e.getAttribute?null:e.getAttribute("data-caman-id"))},r.prototype.domIsLoaded=function(t){var e,i=this;return r.NodeJS?setTimeout(function(){return t.call(i)},0):"complete"===document.readyState?(p.debug("DOM initialized"),setTimeout(function(){return t.call(i)},0)):(e=function(){if("complete"===document.readyState)return p.debug("DOM initialized"),t.call(i)},document.addEventListener("readystatechange",e,!1))},r.prototype.parseArguments=function(t){var e,i,r,n;if(0===t.length)throw"Invalid arguments given";if(this.initObj=null,this.initType=null,this.imageUrl=null,this.callback=function(){},this.setInitObject(t[0]),1!==t.length){switch(typeof t[1]){case"string":this.imageUrl=t[1];break;case"function":this.callback=t[1]}if(2!==t.length&&(this.callback=t[2],4===t.length)){r=t[4],n=[];for(e in r)P.call(r,e)&&(i=r[e],n.push(this.options[e]=i));return n}}},r.prototype.setInitObject=function(e){if(r.NodeJS)return this.initObj=e,void(this.initType="node");if("object"==typeof e?this.initObj=e:this.initObj=t(e),null==this.initObj)throw"Could not find image or canvas for initialization.";return this.initType=this.initObj.nodeName.toLowerCase()},r.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas()}},r.prototype.initNode=function(){return p.debug("Initializing for NodeJS"),"string"==typeof this.initObj?D.readFile(this.initObj,this.nodeFileReady):this.nodeFileReady(null,this.initObj)},r.prototype.nodeFileReady=function(t,e){if(t)throw t;return this.image=new g,this.image.src=e,p.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.canvas=new a(this.imageWidth(),this.imageHeight()),this.finishInit()},r.prototype.initImage=function(){return this.image=this.initObj,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),w.copyAttributes(this.image,this.canvas,{except:["src"]}),this.image.parentNode.replaceChild(this.canvas,this.image),this.imageAdjustments(),this.waitForImageLoaded()},r.prototype.initCanvas=function(){return this.canvas=this.initObj,this.context=this.canvas.getContext("2d"),null!=this.imageUrl?(this.image=document.createElement("img"),this.image.src=this.imageUrl,this.imageAdjustments(),this.waitForImageLoaded()):this.finishInit()},r.prototype.imageAdjustments=function(){if(this.needsHiDPISwap()&&(p.debug(this.image.src,"->",this.hiDPIReplacement()),this.swapped=!0,this.image.src=this.hiDPIReplacement()),u.isRemote(this.image))return this.image.src=u.proxyUrl(this.image.src),p.debug("Remote image detected, using URL = "+this.image.src)},r.prototype.waitForImageLoaded=function(){return this.isImageLoaded()?this.imageLoaded():this.image.onload=this.imageLoaded},r.prototype.isImageLoaded=function(){return!!this.image.complete&&(null==this.image.naturalWidth||0!==this.image.naturalWidth)},r.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth},r.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight},r.prototype.imageLoaded=function(){return p.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.swapped?(this.canvas.width=this.imageWidth()/this.hiDPIRatio(),this.canvas.height=this.imageHeight()/this.hiDPIRatio()):(this.canvas.width=this.imageWidth(),this.canvas.height=this.imageHeight()),this.finishInit()},r.prototype.finishInit=function(){var t,e,i,n,s;if(null==this.context&&(this.context=this.canvas.getContext("2d")),this.originalWidth=this.preScaledWidth=this.width=this.canvas.width,this.originalHeight=this.preScaledHeight=this.height=this.canvas.height,this.hiDPIAdjustments(),this.hasId()||this.assignId(),null!=this.image&&this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data,r.allowRevert)for(this.initializedPixelData=w.dataArray(this.pixelData.length),this.originalPixelData=w.dataArray(this.pixelData.length),s=this.pixelData,t=i=0,n=s.length;i<n;t=++i)e=s[t],this.initializedPixelData[t]=e,this.originalPixelData[t]=e;return this.dimensions={width:this.canvas.width,height:this.canvas.height},r.NodeJS||x.put(this.id,this),this.callback.call(this,this),this.callback=function(){}},r.prototype.reloadCanvasData=function(){return this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data},r.prototype.resetOriginalPixelData=function(){var t,e,i,n,s,a;if(!r.allowRevert)throw"Revert disabled";for(this.originalPixelData=w.dataArray(this.pixelData.length),s=this.pixelData,a=[],t=i=0,n=s.length;i<n;t=++i)e=s[t],a.push(this.originalPixelData[t]=e);return a},r.prototype.hasId=function(){return null!=r.getAttrId(this.canvas)},r.prototype.assignId=function(){if(!r.NodeJS&&!this.canvas.getAttribute("data-caman-id"))return this.canvas.setAttribute("data-caman-id",this.id)},r.prototype.hiDPIDisabled=function(){return null!==this.canvas.getAttribute("data-caman-hidpi-disabled")},r.prototype.hiDPIAdjustments=function(){var t;if(!r.NodeJS&&this.needsHiDPISwap())return t=this.hiDPIRatio(),1!==t?(p.debug("HiDPI ratio = "+t),this.scaled=!0,this.preScaledWidth=this.canvas.width,this.preScaledHeight=this.canvas.height,this.canvas.width=this.preScaledWidth*t,this.canvas.height=this.preScaledHeight*t,this.canvas.style.width=""+this.preScaledWidth+"px",this.canvas.style.height=""+this.preScaledHeight+"px",this.context.scale(t,t),this.width=this.originalWidth=this.canvas.width,this.height=this.originalHeight=this.canvas.height):void 0},r.prototype.hiDPIRatio=function(){var t,e;return e=window.devicePixelRatio||1,t=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,e/t},r.prototype.hiDPICapable=function(){return null!=window.devicePixelRatio&&1!==window.devicePixelRatio},r.prototype.needsHiDPISwap=function(){return!(this.hiDPIDisabled()||!this.hiDPICapable())&&null!==this.hiDPIReplacement()},r.prototype.hiDPIReplacement=function(){return null==this.image?null:this.image.getAttribute("data-caman-hidpi")},r.prototype.replaceCanvas=function(t){var e;return e=this.canvas,this.canvas=t,this.context=this.canvas.getContext("2d"),r.NodeJS||e.parentNode.replaceChild(this.canvas,e),this.width=this.canvas.width,this.height=this.canvas.height,this.reloadCanvasData(),this.dimensions={width:this.canvas.width,height:this.canvas.height}},r.prototype.render=function(t){var e=this;return null==t&&(t=function(){}),h.trigger(this,"renderStart"),this.renderer.execute(function(){return e.context.putImageData(e.imageData,0,0),t.call(e)})},r.prototype.revert=function(t){var e,i,n,s,a;if(null==t&&(t=!0),!r.allowRevert)throw"Revert disabled";for(a=this.originalVisiblePixels(),e=n=0,s=a.length;n<s;e=++n)i=a[e],this.pixelData[e]=i;if(t)return this.context.putImageData(this.imageData,0,0)},r.prototype.reset=function(){var t,e,i,r,n,s,a,o,h;for(t=document.createElement("canvas"),w.copyAttributes(this.canvas,t),t.width=this.originalWidth,t.height=this.originalHeight,e=t.getContext("2d"),r=e.getImageData(0,0,t.width,t.height),s=r.data,h=this.initializedPixelData,i=a=0,o=h.length;a<o;i=++a)n=h[i],s[i]=n;return e.putImageData(r,0,0),this.cropCoordinates={x:0,y:0},this.resized=!1,this.replaceCanvas(t)},r.prototype.originalVisiblePixels=function(){var t,e,i,n,s,a,o,h,l,c,u,g,d,p,f,v,b,y,x,w,D;if(!r.allowRevert)throw"Revert disabled";if(c=[],g=this.cropCoordinates.x,n=g+this.width,d=this.cropCoordinates.y,s=d+this.height,this.resized){for(t=document.createElement("canvas"),t.width=this.originalWidth,t.height=this.originalHeight,i=t.getContext("2d"),o=i.getImageData(0,0,t.width,t.height),l=o.data,y=this.originalPixelData,a=f=0,b=y.length;f<b;a=++f)h=y[a],l[a]=h;i.putImageData(o,0,0),u=document.createElement("canvas"),u.width=this.width,u.height=this.height,i=u.getContext("2d"),i.drawImage(t,0,0,this.originalWidth,this.originalHeight,0,0,this.width,this.height),l=i.getImageData(0,0,this.width,this.height).data,p=this.width}else l=this.originalPixelData,p=this.originalWidth;for(a=v=0,x=l.length;v<x;a=v+=4)e=m.locationToCoordinates(a,p),g<=(w=e.x)&&w<n&&d<=(D=e.y)&&D<s&&c.push(l[a],l[a+1],l[a+2],l[a+3]);return c},r.prototype.process=function(t,e){return this.renderer.add({type:c.Type.Single,name:t,processFn:e}),this},r.prototype.processKernel=function(t,e,i,r){var n,s,a;if(null==i&&(i=null),null==r&&(r=0),null==i)for(i=0,n=s=0,a=e.length;0<=a?s<a:s>a;n=0<=a?++s:--s)i+=e[n];return this.renderer.add({type:c.Type.Kernel,name:t,adjust:e,divisor:i,bias:r}),this},r.prototype.processPlugin=function(t,e){return this.renderer.add({type:c.Type.Plugin,plugin:t,args:e}),this},r.prototype.newLayer=function(t){var e;return e=new d(this),this.canvasQueue.push(e),this.renderer.add({type:c.Type.LayerDequeue}),t.call(e),this.renderer.add({type:c.Type.LayerFinished}),this},r.prototype.executeLayer=function(t){return this.pushContext(t)},r.prototype.pushContext=function(t){return this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixelData),this.currentLayer=t,this.pixelData=t.pixelData},r.prototype.popContext=function(){return this.pixelData=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()},r.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent()},r}(f),y.Caman=n,n.Analyze=function(){function t(t){this.c=t}return t.prototype.calculateLevels=function(){var t,e,i,r,n,s,a;for(e={r:{},g:{},b:{}},t=r=0;r<=255;t=++r)e.r[t]=0,e.g[t]=0,e.b[t]=0;for(t=n=0,a=this.c.pixelData.length;n<a;t=n+=4)e.r[this.c.pixelData[t]]++,e.g[this.c.pixelData[t+1]]++,e.b[this.c.pixelData[t+2]]++;for(i=this.c.pixelData.length/4,t=s=0;s<=255;t=++s)e.r[t]/=i,e.g[t]/=i,e.b[t]/=i;return e},t}(),e=n.Analyze,n.DOMUpdated=function(){var t,e,i,r,n,a;if(e=document.querySelectorAll("img[data-caman]"),e.length>0){for(a=[],r=0,n=e.length;r<n;r++)t=e[r],a.push(i=new s(t,function(){return this.parse(),this.execute()}));return a}},n.autoload&&!function(){return"complete"===document.readyState?n.DOMUpdated():document.addEventListener("DOMContentLoaded",n.DOMUpdated,!1)}(),s=function(){function t(t,e){this.dataStr=t.getAttribute("data-caman"),this.caman=n(t,e.bind(this))}var e;return e="(\\w+)\\((.*?)\\)",t.prototype.parse=function(){var t,i,r,n,s,a,o,h,l,c,u,g,d;if(this.ele=this.caman.canvas,h=new RegExp(e,"g"),l=this.dataStr.match(h),l.length>0){for(h=new RegExp(e),d=[],c=0,u=l.length;c<u;c++){s=l[c],g=s.match(h),o=g[0],r=g[1],t=g[2],a=new Function("return function() {        this."+r+"("+t+");      };");try{n=a(),d.push(n.call(this.caman))}catch(f){i=f,d.push(p.debug(i))}}return d}},t.prototype.execute=function(){var t;return t=this.ele,this.caman.render(function(){return t.parentNode.replaceChild(this.toImage(),t)})},t}(),n.Blender=function(){function t(){}return t.blenders={},t.register=function(t,e){return this.blenders[t]=e},t.execute=function(t,e,i){return this.blenders[t](e,i)},t}(),i=n.Blender,n.Calculate=function(){function t(){}return t.distance=function(t,e,i,r){return Math.sqrt(Math.pow(i-t,2)+Math.pow(r-e,2))},t.randomRange=function(t,e,i){var r;return null==i&&(i=!1),r=t+Math.random()*(e-t),i?r.toFixed(i):Math.round(r)},t.luminance=function(t){return.299*t.r+.587*t.g+.114*t.b},t.bezier=function(t,e,i,r,n,s){var a,o,h,l,c,u,g,d,p,f,m,v,b,y,x,w,D,I,R,S,C,M,P,k,F,B,L;for(x=t[0],R=t[1],w=e[0],S=e[1],D=i[0],C=i[1],I=r[0],M=r[1],g={},c=parseInt(3*(w-x),10),h=3*(D-w)-c,a=I-x-c-h,u=3*(S-R),l=3*(C-S)-u,o=M-R-u-l,f=P=0;P<1e3;f=++P)y=f/1e3,d=Math.round(a*Math.pow(y,3)+h*Math.pow(y,2)+c*y+x),p=Math.round(o*Math.pow(y,3)+l*Math.pow(y,2)+u*y+R),n&&p<n?p=n:s&&p>s&&(p=s),g[d]=p;if(g.length<r[0]+1)for(f=k=0,B=r[0];0<=B?k<=B:k>=B;f=0<=B?++k:--k)if(null==g[f]){for(v=[f-1,g[f-1]],m=F=f,L=r[0];f<=L?F<=L:F>=L;m=f<=L?++F:--F)if(null!=g[m]){b=[m,g[m]];break}g[f]=v[1]+(b[1]-v[1])/(b[0]-v[0])*(f-v[0])}return null==g[r[0]]&&(g[r[0]]=g[r[0]-1]),g},t}(),r=n.Calculate,n.Convert=function(){function t(){}return t.hexToRGB=function(t){var e,i,r;return"#"===t.charAt(0)&&(t=t.substr(1)),r=parseInt(t.substr(0,2),16),i=parseInt(t.substr(2,2),16),e=parseInt(t.substr(4,2),16),{r:r,g:i,b:e}},t.rgbToHSL=function(t,e,i){var r,n,s,a,o,h;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),t/=255,e/=255,i/=255,a=Math.max(t,e,i),o=Math.min(t,e,i),s=(a+o)/2,a===o?n=h=0:(r=a-o,h=s>.5?r/(2-a-o):r/(a+o),n=function(){switch(a){case t:return(e-i)/r+(e<i?6:0);case e:return(i-t)/r+2;case i:return(t-e)/r+4}}(),n/=6),{h:n,s:h,l:s}},t.hslToRGB=function(t,e,i){var r,n,s,a,o;return"object"==typeof t&&(e=t.s,i=t.l,t=t.h),0===e?o=n=r=i:(a=i<.5?i*(1+e):i+e-i*e,s=2*i-a,o=this.hueToRGB(s,a,t+1/3),n=this.hueToRGB(s,a,t),r=this.hueToRGB(s,a,t-1/3)),{r:255*o,g:255*n,b:255*r}},t.hueToRGB=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},t.rgbToHSV=function(t,e,i){var r,n,s,a,o,h;return t/=255,e/=255,i/=255,s=Math.max(t,e,i),a=Math.min(t,e,i),h=s,r=s-a,o=0===s?0:r/s,s===a?n=0:(n=function(){switch(s){case t:return(e-i)/r+(e<i?6:0);case e:return(i-t)/r+2;case i:return(t-e)/r+4}}(),n/=6),{h:n,s:o,v:h}},t.hsvToRGB=function(t,e,i){var r,n,s,a,o,h,l,c;switch(a=Math.floor(6*t),n=6*t-a,o=i*(1-e),h=i*(1-n*e),c=i*(1-(1-n)*e),a%6){case 0:l=i,s=c,r=o;break;case 1:l=h,s=i,r=o;break;case 2:l=o,s=i,r=c;break;case 3:l=o,s=h,r=i;break;case 4:l=c,s=o,r=i;break;case 5:l=i,s=o,r=h}return{r:Math.floor(255*l),g:Math.floor(255*s),b:Math.floor(255*r)}},t.rgbToXYZ=function(t,e,i){var r,n,s;return t/=255,e/=255,i/=255,t>.04045?t=Math.pow((t+.055)/1.055,2.4):t/=12.92,e>.04045?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,i>.04045?i=Math.pow((i+.055)/1.055,2.4):i/=12.92,r=.4124*t+.3576*e+.1805*i,n=.2126*t+.7152*e+.0722*i,s=.0193*t+.1192*e+.9505*i,{x:100*r,y:100*n,z:100*s}},t.xyzToRGB=function(t,e,i){var r,n,s;return t/=100,e/=100,i/=100,s=3.2406*t+-1.5372*e+-.4986*i,n=-.9689*t+1.8758*e+.0415*i,r=.0557*t+-.204*e+1.057*i,s>.0031308?s=1.055*Math.pow(s,.4166666667)-.055:s*=12.92,n>.0031308?n=1.055*Math.pow(n,.4166666667)-.055:n*=12.92,r>.0031308?r=1.055*Math.pow(r,.4166666667)-.055:r*=12.92,{r:255*s,g:255*n,b:255*r}},t.xyzToLab=function(t,e,i){var r,n,s,a,o,h;return"object"==typeof t&&(e=t.y,i=t.z,t=t.x),a=95.047,o=100,h=108.883,t/=a,e/=o,i/=h,t=t>.008856451679?Math.pow(t,.3333333333):7.787037037*t+.1379310345,e=e>.008856451679?Math.pow(e,.3333333333):7.787037037*e+.1379310345,i=i>.008856451679?Math.pow(i,.3333333333):7.787037037*i+.1379310345,s=116*e-16,r=500*(t-e),n=200*(e-i),{l:s,a:r,b:n}},t.labToXYZ=function(t,e,i){var r,n,s;return"object"==typeof t&&(e=t.a,i=t.b,t=t.l),n=(t+16)/116,r=n+e/500,s=n-i/200,r=r>.2068965517?r*r*r:.1284185493*(r-.1379310345),n=n>.2068965517?n*n*n:.1284185493*(n-.1379310345),s=s>.2068965517?s*s*s:.1284185493*(s-.1379310345),{x:95.047*r,y:100*n,z:108.883*s}},t.rgbToLab=function(t,e,i){var r;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),r=this.rgbToXYZ(t,e,i),this.xyzToLab(r)},t.labToRGB=function(t,e,i){},t}(),o=n.Convert,n.Event=function(){function t(){}return t.events={},t.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"],t.trigger=function(t,e,i){var r,n,s,a,o;if(null==i&&(i=null),this.events[e]&&this.events[e].length){for(a=this.events[e],o=[],n=0,s=a.length;n<s;n++)r=a[n],null===r.target||t.id===r.target.id?o.push(r.fn.call(t,i)):o.push(void 0);return o}},t.listen=function(t,e,i){var r,n;return"string"==typeof t&&(n=t,r=e,t=null,e=n,i=r),!(C.call(this.types,e)<0)&&(this.events[e]||(this.events[e]=[]),this.events[e].push({target:t,fn:i}),!0)},t}(),h=n.Event,n.Filter=function(){function t(){}return t.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6},t.register=function(t,e){return n.prototype[t]=e},t}(),c=n.Filter,n.IO=function(){function t(){}return t.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/,t.isRemote=function(t){return null!=t&&(!this.corsEnabled(t)&&this.isURLRemote(t.src))},t.corsEnabled=function(t){var e;return null!=t.crossOrigin&&("anonymous"===(e=t.crossOrigin.toLowerCase())||"use-credentials"===e)},t.isURLRemote=function(t){var e;return e=t.match(this.domainRegex),!!e&&e[1]!==document.domain},t.remoteCheck=function(t){if(this.isURLRemote(t)){if(n.remoteProxy.length)return n.isURLRemote(n.remoteProxy)?void p.info("Cannot use a remote proxy for loading images."):this.proxyUrl(t);p.info("Attempting to load a remote image without a configured proxy. URL: "+t)}},t.proxyUrl=function(t){return""+n.remoteProxy+"?"+n.proxyParam+"="+encodeURIComponent(t)},t.useProxy=function(t){var e;return e={ruby:"rb",python:"py",perl:"pl",javascript:"js"},t=t.toLowerCase(),null!=e[t]&&(t=e[t]),"proxies/caman_proxy."+t},t}(),n.prototype.save=function(){return"undefined"!=typeof exports&&null!==exports?this.nodeSave.apply(this,arguments):this.browserSave.apply(this,arguments)},n.prototype.browserSave=function(t){var e;return null==t&&(t="png"),t=t.toLowerCase(),e=this.toBase64(t).replace("image/"+t,"image/octet-stream"),document.location.href=e},n.prototype.nodeSave=function(t,e){var i,r;null==e&&(e=!0);try{if(r=D.statSync(t),r.isFile()&&!e)return!1}catch(n){i=n,p.debug("Creating output file "+t)}return D.writeFile(t,this.canvas.toBuffer(),function(){return p.debug("Finished writing to "+t)})},n.prototype.toImage=function(t){var e;return e=document.createElement("img"),e.src=this.toBase64(t),e.width=this.dimensions.width,e.height=this.dimensions.height,window.devicePixelRatio&&(e.width/=window.devicePixelRatio,e.height/=window.devicePixelRatio),e},n.prototype.toBase64=function(t){return null==t&&(t="png"),t=t.toLowerCase(),this.canvas.toDataURL("image/"+t)},u=n.IO,n.Layer=function(){function e(t){this.c=t,this.filter=this.c,this.options={blendingMode:"normal",opacity:1},this.layerID=w.uniqid.get(),this.canvas="undefined"!=typeof exports&&null!==exports?new a:document.createElement("canvas"),this.canvas.width=this.c.dimensions.width,this.canvas.height=this.c.dimensions.height,this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}return e.prototype.newLayer=function(t){return this.c.newLayer.call(this.c,t)},e.prototype.setBlendingMode=function(t){return this.options.blendingMode=t,this},e.prototype.opacity=function(t){return this.options.opacity=t/100,this},e.prototype.copyParent=function(){var t,e,i,r;for(e=this.c.pixelData,t=i=0,r=this.c.pixelData.length;i<r;t=i+=4)this.pixelData[t]=e[t],this.pixelData[t+1]=e[t+1],this.pixelData[t+2]=e[t+2],this.pixelData[t+3]=e[t+3];return this},e.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments)},e.prototype.overlayImage=function(e){return"object"==typeof e?e=e.src:"string"==typeof e&&"#"===e[0]&&(e=t(e).src),e?(this.c.renderer.renderQueue.push({type:c.Type.LoadOverlay,src:e,layer:this}),this):this},e.prototype.applyToParent=function(){var t,e,r,n,s,a,o,h,l;for(r=this.c.pixelStack[this.c.pixelStack.length-1],e=this.c.pixelData,l=[],t=o=0,h=e.length;o<h;t=o+=4)a={r:r[t],g:r[t+1],b:r[t+2],a:r[t+3]},s={r:e[t],g:e[t+1],b:e[t+2],a:e[t+3]},n=i.execute(this.options.blendingMode,s,a),n.r=w.clampRGB(n.r),n.g=w.clampRGB(n.g),n.b=w.clampRGB(n.b),null==n.a&&(n.a=s.a),r[t]=a.r-(a.r-n.r)*(this.options.opacity*(n.a/255)),r[t+1]=a.g-(a.g-n.g)*(this.options.opacity*(n.a/255)),l.push(r[t+2]=a.b-(a.b-n.b)*(this.options.opacity*(n.a/255)));return l},e}(),d=n.Layer,n.Logger=function(){function t(){var t,e,i,r;for(r=["log","info","warn","error"],e=0,i=r.length;e<i;e++)t=r[e],this[t]=function(t){return function(){var e,i;if(e=1<=arguments.length?M.call(arguments,0):[],n.DEBUG)try{return console[t].apply(console,e)}catch(r){return i=r,console[t](e)}}}(t);this.debug=this.log}return t}(),p=new n.Logger,n.Pixel=function(){function t(t,e,i,r,n){this.r=null!=t?t:0,this.g=null!=e?e:0,this.b=null!=i?i:0,this.a=null!=r?r:255,this.c=null!=n?n:null,this.loc=0}return t.coordinatesToLocation=function(t,e,i){return 4*(e*i+t)},t.locationToCoordinates=function(t,e){var i,r;return r=Math.floor(t/(4*e)),i=t%(4*e)/4,{x:i,y:r}},t.prototype.setContext=function(t){return this.c=t},t.prototype.locationXY=function(){var t,e;if(null==this.c)throw"Requires a CamanJS context";return e=this.c.dimensions.height-Math.floor(this.loc/(4*this.c.dimensions.width)),t=this.loc%(4*this.c.dimensions.width)/4,{x:t,y:e}},t.prototype.pixelAtLocation=function(e){if(null==this.c)throw"Requires a CamanJS context";return new t(this.c.pixelData[e],this.c.pixelData[e+1],this.c.pixelData[e+2],this.c.pixelData[e+3],this.c)},t.prototype.getPixelRelative=function(e,i){var r;if(null==this.c)throw"Requires a CamanJS context";return r=this.loc+4*this.c.dimensions.width*(i*-1)+4*e,r>this.c.pixelData.length||r<0?new t(0,0,0,255,this.c):this.pixelAtLocation(r)},t.prototype.putPixelRelative=function(t,e,i){var r;if(null==this.c)throw"Requires a CamanJS context";if(r=this.loc+4*this.c.dimensions.width*(e*-1)+4*t,!(newLoc>this.c.pixelData.length||newLoc<0))return this.c.pixelData[newLoc]=i.r,this.c.pixelData[newLoc+1]=i.g,this.c.pixelData[newLoc+2]=i.b,this.c.pixelData[newLoc+3]=i.a,!0},t.prototype.getPixel=function(t,e){var i;if(null==this.c)throw"Requires a CamanJS context";return i=this.coordinatesToLocation(t,e,this.width),this.pixelAtLocation(i)},t.prototype.putPixel=function(t,e,i){var r;if(null==this.c)throw"Requires a CamanJS context";return r=this.coordinatesToLocation(t,e,this.width),this.c.pixelData[r]=i.r,this.c.pixelData[r+1]=i.g,this.c.pixelData[r+2]=i.b,this.c.pixelData[r+3]=i.a},t.prototype.toString=function(){return this.toKey()},t.prototype.toHex=function(t){var e;return null==t&&(t=!1),e="#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16),t?e+this.a.toString(16):e},t}(),m=n.Pixel,n.Plugin=function(){function t(){}return t.plugins={},t.register=function(t,e){return this.plugins[t]=e},t.execute=function(t,e,i){return this.plugins[e].apply(t,i)},t}(),v=n.Plugin,n.Renderer=function(){function t(t){this.c=t,this.processNext=k(this.processNext,this),this.renderQueue=[],this.modPixelData=null}return t.Blocks=n.NodeJS?require("os").cpus().length:4,t.prototype.add=function(t){if(null!=t)return this.renderQueue.push(t)},t.prototype.processNext=function(){var t;if(0===this.renderQueue.length)return h.trigger(this,"renderFinished"),null!=this.finishedFn&&this.finishedFn.call(this.c),
this;switch(this.currentJob=this.renderQueue.shift(),this.currentJob.type){case c.Type.LayerDequeue:return t=this.c.canvasQueue.shift(),this.c.executeLayer(t),this.processNext();case c.Type.LayerFinished:return this.c.applyCurrentLayer(),this.c.popContext(),this.processNext();case c.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case c.Type.Plugin:return this.executePlugin();default:return this.executeFilter()}},t.prototype.execute=function(t){return this.finishedFn=t,this.modPixelData=w.dataArray(this.c.pixelData.length),this.processNext()},t.prototype.eachBlock=function(e){var i,r,s,a,o,h,c,u,g,d,p,f,m=this;for(this.blocksDone=0,u=this.c.pixelData.length,r=Math.floor(u/4/t.Blocks),i=4*r,c=i+u/4%t.Blocks*4,f=[],h=d=0,p=t.Blocks;0<=p?d<p:d>p;h=0<=p?++d:--d)g=h*i,a=g+(h===t.Blocks-1?c:i),n.NodeJS?(o=l(function(){return e.call(m,h,g,a)}),s=o.run(),f.push(this.blockFinished(s))):f.push(setTimeout(function(t,i,r){return function(){return e.call(m,t,i,r)}}(h,g,a),0));return f},t.prototype.executeFilter=function(){return h.trigger(this.c,"processStart",this.currentJob),this.currentJob.type===c.Type.Single?this.eachBlock(this.renderBlock):this.eachBlock(this.renderKernel)},t.prototype.executePlugin=function(){return p.debug("Executing plugin "+this.currentJob.plugin),v.execute(this.c,this.currentJob.plugin,this.currentJob.args),p.debug("Plugin "+this.currentJob.plugin+" finished!"),this.processNext()},t.prototype.renderBlock=function(e,i,r){var s,a,o;for(p.debug("Block #"+e+" - Filter: "+this.currentJob.name+", Start: "+i+", End: "+r),h.trigger(this.c,"blockStarted",{blockNum:e,totalBlocks:t.Blocks,startPixel:i,endPixel:r}),a=new m,a.setContext(this.c),s=o=i;o<r;s=o+=4)a.loc=s,a.r=this.c.pixelData[s],a.g=this.c.pixelData[s+1],a.b=this.c.pixelData[s+2],a.a=this.c.pixelData[s+3],this.currentJob.processFn(a),this.c.pixelData[s]=w.clampRGB(a.r),this.c.pixelData[s+1]=w.clampRGB(a.g),this.c.pixelData[s+2]=w.clampRGB(a.b),this.c.pixelData[s+3]=w.clampRGB(a.a);return n.NodeJS?l["yield"](e):this.blockFinished(e)},t.prototype.renderKernel=function(t,e,i){var r,s,a,o,h,c,u,g,d,f,v,b,y,x,D,I,R,S;for(b=this.currentJob.name,a=this.currentJob.bias,c=this.currentJob.divisor,v=this.c.pixelData.length,r=this.currentJob.adjust,s=Math.sqrt(r.length),f=[],p.debug("Rendering kernel - Filter: "+this.currentJob.name),e=Math.max(e,4*this.c.dimensions.width*((s-1)/2)),i=Math.min(i,v-4*this.c.dimensions.width*((s-1)/2)),o=(s-1)/2,x=new m,x.setContext(this.c),u=I=e;I<i;u=I+=4){for(x.loc=u,h=0,g=R=-o;-o<=o?R<=o:R>=o;g=-o<=o?++R:--R)for(d=S=o;o<=-o?S<=-o:S>=-o;d=o<=-o?++S:--S)y=x.getPixelRelative(g,d),f[3*h]=y.r,f[3*h+1]=y.g,f[3*h+2]=y.b,h++;D=this.processKernel(r,f,c,a),this.modPixelData[u]=w.clampRGB(D.r),this.modPixelData[u+1]=w.clampRGB(D.g),this.modPixelData[u+2]=w.clampRGB(D.b),this.modPixelData[u+3]=this.c.pixelData[u+3]}return n.NodeJS?l["yield"](t):this.blockFinished(t)},t.prototype.blockFinished=function(e){var i,r,n;if(e>=0&&p.debug("Block #"+e+" finished! Filter: "+this.currentJob.name),this.blocksDone++,h.trigger(this.c,"blockFinished",{blockNum:e,blocksFinished:this.blocksDone,totalBlocks:t.Blocks}),this.blocksDone===t.Blocks){if(this.currentJob.type===c.Type.Kernel)for(i=r=0,n=this.c.pixelData.length;0<=n?r<n:r>n;i=0<=n?++r:--r)this.c.pixelData[i]=this.modPixelData[i];return e>=0&&p.debug("Filter "+this.currentJob.name+" finished!"),h.trigger(this.c,"processComplete",this.currentJob),this.processNext()}},t.prototype.processKernel=function(t,e,i,r){var n,s,a,o;for(s={r:0,g:0,b:0},n=a=0,o=t.length;0<=o?a<o:a>o;n=0<=o?++a:--a)s.r+=t[n]*e[3*n],s.g+=t[n]*e[3*n+1],s.b+=t[n]*e[3*n+2];return s.r=s.r/i+r,s.g=s.g/i+r,s.b=s.b/i+r,s},t.prototype.loadOverlay=function(t,e){var i,r,n=this;return i=document.createElement("img"),i.onload=function(){return t.context.drawImage(i,0,0,n.c.dimensions.width,n.c.dimensions.height),t.imageData=t.context.getImageData(0,0,n.c.dimensions.width,n.c.dimensions.height),t.pixelData=t.imageData.data,n.c.pixelData=t.pixelData,n.processNext()},r=u.remoteCheck(e),i.src=null!=r?r:e},t}(),b=n.Renderer,n.Store=function(){function t(){}return t.items={},t.has=function(t){return null!=this.items[t]},t.get=function(t){return this.items[t]},t.put=function(t,e){return this.items[t]=e},t.execute=function(t,e){var i=this;return setTimeout(function(){return e.call(i.get(t),i.get(t))},0),this.get(t)},t.flush=function(t){return null==t&&(t=!1),t?delete this.items[t]:this.items={}},t}(),x=n.Store,i.register("normal",function(t,e){return{r:t.r,g:t.g,b:t.b}}),i.register("multiply",function(t,e){return{r:t.r*e.r/255,g:t.g*e.g/255,b:t.b*e.b/255}}),i.register("screen",function(t,e){return{r:255-(255-t.r)*(255-e.r)/255,g:255-(255-t.g)*(255-e.g)/255,b:255-(255-t.b)*(255-e.b)/255}}),i.register("overlay",function(t,e){var i;return i={},i.r=e.r>128?255-2*(255-t.r)*(255-e.r)/255:e.r*t.r*2/255,i.g=e.g>128?255-2*(255-t.g)*(255-e.g)/255:e.g*t.g*2/255,i.b=e.b>128?255-2*(255-t.b)*(255-e.b)/255:e.b*t.b*2/255,i}),i.register("difference",function(t,e){return{r:t.r-e.r,g:t.g-e.g,b:t.b-e.b}}),i.register("addition",function(t,e){return{r:e.r+t.r,g:e.g+t.g,b:e.b+t.b}}),i.register("exclusion",function(t,e){return{r:128-2*(e.r-128)*(t.r-128)/255,g:128-2*(e.g-128)*(t.g-128)/255,b:128-2*(e.b-128)*(t.b-128)/255}}),i.register("softLight",function(t,e){var i;return i={},i.r=e.r>128?255-(255-e.r)*(255-(t.r-128))/255:e.r*(t.r+128)/255,i.g=e.g>128?255-(255-e.g)*(255-(t.g-128))/255:e.g*(t.g+128)/255,i.b=e.b>128?255-(255-e.b)*(255-(t.b-128))/255:e.b*(t.b+128)/255,i}),i.register("lighten",function(t,e){return{r:e.r>t.r?e.r:t.r,g:e.g>t.g?e.g:t.g,b:e.b>t.b?e.b:t.b}}),i.register("darken",function(t,e){return{r:e.r>t.r?t.r:e.r,g:e.g>t.g?t.g:e.g,b:e.b>t.b?t.b:e.b}}),c.register("fillColor",function(){var t;return t=1===arguments.length?o.hexToRGB(arguments[0]):{r:arguments[0],g:arguments[1],b:arguments[2]},this.process("fillColor",function(e){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=255,e})}),c.register("brightness",function(t){return t=Math.floor(255*(t/100)),this.process("brightness",function(e){return e.r+=t,e.g+=t,e.b+=t,e})}),c.register("saturation",function(t){return t*=-.01,this.process("saturation",function(e){var i;return i=Math.max(e.r,e.g,e.b),e.r!==i&&(e.r+=(i-e.r)*t),e.g!==i&&(e.g+=(i-e.g)*t),e.b!==i&&(e.b+=(i-e.b)*t),e})}),c.register("vibrance",function(t){return t*=-1,this.process("vibrance",function(e){var i,r,n;return n=Math.max(e.r,e.g,e.b),r=(e.r+e.g+e.b)/3,i=2*Math.abs(n-r)/255*t/100,e.r!==n&&(e.r+=(n-e.r)*i),e.g!==n&&(e.g+=(n-e.g)*i),e.b!==n&&(e.b+=(n-e.b)*i),e})}),c.register("greyscale",function(t){return this.process("greyscale",function(t){var e;return e=r.luminance(t),t.r=e,t.g=e,t.b=e,t})}),c.register("contrast",function(t){return t=Math.pow((t+100)/100,2),this.process("contrast",function(e){return e.r/=255,e.r-=.5,e.r*=t,e.r+=.5,e.r*=255,e.g/=255,e.g-=.5,e.g*=t,e.g+=.5,e.g*=255,e.b/=255,e.b-=.5,e.b*=t,e.b+=.5,e.b*=255,e})}),c.register("hue",function(t){return this.process("hue",function(e){var i,r,n,s,a,h;return s=o.rgbToHSV(e.r,e.g,e.b),n=100*s.h,n+=Math.abs(t),n%=100,n/=100,s.h=n,h=o.hsvToRGB(s.h,s.s,s.v),a=h.r,r=h.g,i=h.b,e.r=a,e.g=r,e.b=i,e})}),c.register("colorize",function(){var t,e;return 2===arguments.length?(e=o.hexToRGB(arguments[0]),t=arguments[1]):4===arguments.length&&(e={r:arguments[0],g:arguments[1],b:arguments[2]},t=arguments[3]),this.process("colorize",function(i){return i.r-=(i.r-e.r)*(t/100),i.g-=(i.g-e.g)*(t/100),i.b-=(i.b-e.b)*(t/100),i})}),c.register("invert",function(){return this.process("invert",function(t){return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,t})}),c.register("sepia",function(t){return null==t&&(t=100),t/=100,this.process("sepia",function(e){return e.r=Math.min(255,e.r*(1-.607*t)+e.g*(.769*t)+e.b*(.189*t)),e.g=Math.min(255,e.r*(.349*t)+e.g*(1-.314*t)+e.b*(.168*t)),e.b=Math.min(255,e.r*(.272*t)+e.g*(.534*t)+e.b*(1-.869*t)),e})}),c.register("gamma",function(t){return this.process("gamma",function(e){return e.r=255*Math.pow(e.r/255,t),e.g=255*Math.pow(e.g/255,t),e.b=255*Math.pow(e.b/255,t),e})}),c.register("noise",function(t){return t=2.55*Math.abs(t),this.process("noise",function(e){var i;return i=r.randomRange(t*-1,t),e.r+=i,e.g+=i,e.b+=i,e})}),c.register("clip",function(t){return t=2.55*Math.abs(t),this.process("clip",function(e){return e.r>255-t?e.r=255:e.r<t&&(e.r=0),e.g>255-t?e.g=255:e.g<t&&(e.g=0),e.b>255-t?e.b=255:e.b<t&&(e.b=0),e})}),c.register("channels",function(t){var e,i;if("object"!=typeof t)return this;for(e in t)P.call(t,e)&&(i=t[e],0!==i?t[e]/=100:delete t[e]);return 0===t.length?this:this.process("channels",function(e){return null!=t.red&&(t.red>0?e.r+=(255-e.r)*t.red:e.r-=e.r*Math.abs(t.red)),null!=t.green&&(t.green>0?e.g+=(255-e.g)*t.green:e.g-=e.g*Math.abs(t.green)),null!=t.blue&&(t.blue>0?e.b+=(255-e.b)*t.blue:e.b-=e.b*Math.abs(t.blue)),e})}),c.register("curves",function(){var t,e,i,n,s,a,o,h,l,c,u,g;if(e=arguments[0],i=2<=arguments.length?M.call(arguments,1):[],"string"==typeof e&&(e=e.split("")),"v"===e[0]&&(e=["r","g","b"]),i.length<3||i.length>4)throw"Invalid number of arguments to curves filter";if(h=i[0],n=i[1],s=4===i.length?i[2]:i[1],a=i[i.length-1],t=r.bezier(h,n,s,a,0,255),h[0]>0)for(o=l=0,u=h[0];0<=u?l<u:l>u;o=0<=u?++l:--l)t[o]=h[1];if(a[0]<255)for(o=c=g=a[0];g<=255?c<=255:c>=255;o=g<=255?++c:--c)t[o]=a[1];return this.process("curves",function(i){var r,n;for(o=r=0,n=e.length;0<=n?r<n:r>n;o=0<=n?++r:--r)i[e[o]]=t[i[e[o]]];return i})}),c.register("exposure",function(t){var e,i,r;return r=Math.abs(t)/100,e=[0,255*r],i=[255-255*r,255],t<0&&(e=e.reverse(),i=i.reverse()),this.curves("rgb",[0,0],e,i,[255,255])}),n.Plugin.register("crop",function(t,e,i,r){var n,s;return null==i&&(i=0),null==r&&(r=0),"undefined"!=typeof exports&&null!==exports?n=new a(t,e):(n=document.createElement("canvas"),w.copyAttributes(this.canvas,n),n.width=t,n.height=e),s=n.getContext("2d"),s.drawImage(this.canvas,i,r,t,e,0,0,t,e),this.cropCoordinates={x:i,y:r},this.cropped=!0,this.replaceCanvas(n)}),n.Plugin.register("resize",function(t){var e,i;return null==t&&(t=null),null===t||null==t.width&&null==t.height?void p.error("Invalid or missing dimensions given for resize"):(null==t.width?t.width=this.canvas.width*t.height/this.canvas.height:null==t.height&&(t.height=this.canvas.height*t.width/this.canvas.width),"undefined"!=typeof exports&&null!==exports?e=new a(t.width,t.height):(e=document.createElement("canvas"),w.copyAttributes(this.canvas,e),e.width=t.width,e.height=t.height),i=e.getContext("2d"),i.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,t.width,t.height),this.resized=!0,this.replaceCanvas(e))}),n.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0))}),n.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0))}),n.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])}),n.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])}),n.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])}),n.Filter.register("motionBlur",function(t){var e;return e=0===t||180===t?[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]:t>0&&t<90||t>180&&t<270?[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]:90===t||270===t?[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],this.processKernel("Motion Blur",e)}),n.Filter.register("sharpen",function(t){return null==t&&(t=100),t/=100,this.processKernel("Sharpen",[0,-t,0,-t,4*t+1,-t,0,-t,0])}),S={brightness:function(t,e,i){return t.r=t.r-t.r*e*i.strength,t.g=t.g-t.g*e*i.strength,t.b=t.b-t.b*e*i.strength,t},gamma:function(t,e,i){return t.r=255*Math.pow(t.r/255,Math.max(10*e*i.strength,1)),t.g=255*Math.pow(t.g/255,Math.max(10*e*i.strength,1)),t.b=255*Math.pow(t.b/255,Math.max(10*e*i.strength,1)),t},colorize:function(t,e,i){return t.r-=(t.r-i.color.r)*e,t.g-=(t.g-i.color.g)*e,t.b-=(t.b-i.color.b)*e,t}},c.register("vignette",function(t,e){var i,n,s,a;return null==e&&(e=60),"string"==typeof t&&"%"===t.substr(-1)&&(t=this.dimensions.height>this.dimensions.width?this.dimensions.width*(parseInt(t.substr(0,t.length-1),10)/100):this.dimensions.height*(parseInt(t.substr(0,t.length-1),10)/100)),e/=100,n=[this.dimensions.width/2,this.dimensions.height/2],a=Math.sqrt(Math.pow(n[0],2)+Math.pow(n[1],2)),s=a-t,i=r.bezier([0,1],[30,30],[70,60],[100,80]),this.process("vignette",function(a){var o,h,l;return l=a.locationXY(),o=r.distance(l.x,l.y,n[0],n[1]),o>s&&(h=Math.max(1,i[Math.round((o-s)/t*100)]/10*e),a.r=255*Math.pow(a.r/255,h),a.g=255*Math.pow(a.g/255,h),a.b=255*Math.pow(a.b/255,h)),a})}),c.register("rectangularVignette",function(t){var e,i,s,a,h,l,c;if(e={strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}},t=w.extend(e,t),!t.size)return this;if("string"==typeof t.size)s=parseInt(t.size,10)/100,t.size={width:this.dimensions.width*s,height:this.dimensions.height*s};else if("object"==typeof t.size)for(c=["width","height"],h=0,l=c.length;h<l;h++)i=c[h],"string"==typeof t.size[i]&&(t.size[i]=this.dimensions[i]*(parseInt(t.size[i],10)/100));else"number"===t.size&&(a=t.size,t.size={width:a,height:a});return"string"==typeof t.cornerRadius&&(t.cornerRadius=t.size.width/2*(parseInt(t.cornerRadius,10)/100)),t.strength/=100,t.size.width=Math.floor(t.size.width),t.size.height=Math.floor(t.size.height),t.image={width:this.dimensions.width,height:this.dimensions.height},"colorize"===t.method&&"string"==typeof t.color&&(t.color=o.hexToRGB(t.color)),t.coords={left:(this.dimensions.width-t.size.width)/2,right:this.dimensions.width-t.coords.left,bottom:(this.dimensions.height-t.size.height)/2,top:this.dimensions.height-t.coords.bottom},t.corners=[{x:t.coords.left+t.cornerRadius,y:t.coords.top-t.cornerRadius},{x:t.coords.right-t.cornerRadius,y:t.coords.top-t.cornerRadius},{x:t.coords.right-t.cornerRadius,y:t.coords.bottom+t.cornerRadius},{x:t.coords.left+t.cornerRadius,y:t.coords.bottom+t.cornerRadius}],t.maxDist=r.distance(0,0,t.corners[3].x,t.corners[3].y)-t.cornerRadius,this.process("rectangularVignette",function(e){var i,r,s;return r=e.locationXY(),r.x>t.corners[0].x&&r.x<t.corners[1].x&&r.y>t.coords.bottom&&r.y<t.coords.top?e:r.x>t.coords.left&&r.x<t.coords.right&&r.y>t.corners[3].y&&r.y<t.corners[2].y?e:(r.x>t.corners[0].x&&r.x<t.corners[1].x&&r.y>t.coords.top?i=(r.y-t.coords.top)/t.maxDist:r.y>t.corners[2].y&&r.y<t.corners[1].y&&r.x>t.coords.right?i=(r.x-t.coords.right)/t.maxDist:r.x>t.corners[0].x&&r.x<t.corners[1].x&&r.y<t.coords.bottom?i=(t.coords.bottom-r.y)/t.maxDist:r.y>t.corners[2].y&&r.y<t.corners[1].y&&r.x<t.coords.left?i=(t.coords.left-r.x)/t.maxDist:r.x<=t.corners[0].x&&r.y>=t.corners[0].y?(s=n.distance(r.x,r.y,t.corners[0].x,t.corners[0].y),i=(s-t.cornerRadius)/t.maxDist):r.x>=t.corners[1].x&&r.y>=t.corners[1].y?(s=n.distance(r.x,r.y,t.corners[1].x,t.corners[1].y),i=(s-t.cornerRadius)/t.maxDist):r.x>=t.corners[2].x&&r.y<=t.corners[2].y?(s=n.distance(r.x,r.y,t.corners[2].x,t.corners[2].y),i=(s-t.cornerRadius)/t.maxDist):r.x<=t.corners[3].x&&r.y<=t.corners[3].y&&(s=n.distance(r.x,r.y,t.corners[3].x,t.corners[3].y),i=(s-t.cornerRadius)/t.maxDist),i<0?e:S[t.method](e,i,t))})}),function(){var t,e,i,r,s;return r=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],s=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],e=function(t,e,i,r,n,s,o){var h,l,c,u,g,d,p;return h="undefined"!=typeof exports&&null!==exports?new a:document.createElement("canvas"),h.width=t,h.height=e,u=i+Math.cos(n)*s*.5,d=r+Math.sin(n)*s*.5,g=i-Math.cos(n)*s*.5,p=r-Math.sin(n)*s*.5,l=h.getContext("2d"),c=l.createLinearGradient(u,d,g,p),o?(c.addColorStop(0,"white"),c.addColorStop(.5,"black"),c.addColorStop(1,"white")):(c.addColorStop(0,"white"),c.addColorStop(1,"black")),l.fillStyle=c,l.fillRect(0,0,t,e),l.getImageData(0,0,t,e)},i=function(t,e,i,r,n,s){var o,h,l;return o="undefined"!=typeof exports&&null!==exports?new a:document.createElement("canvas"),o.width=t,o.height=e,h=o.getContext("2d"),l=h.createRadialGradient(i,r,n,i,r,s),l.addColorStop(1,"white"),l.addColorStop(0,"black"),h.fillStyle=l,h.fillRect(0,0,t,e),h.getImageData(0,0,t,e)},t=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},n.Plugin.register("compoundBlur",function(e,i,n,a){var o,h,l,c,u,g,d,p,f,m,v,b,y,x,w,D,I,R,S,C,M,P,k,F,B,L,T,E,O,A,z,N,H,J,G,j,U,_,W,q,V,K,Q,Y,X,Z,$,tt,et,it,rt,nt,st,at,ot,ht,lt,ct;for(K=this.dimensions.width,m=this.dimensions.height,w=this.pixelData,E=e.data,q=K*m,V=q<<2,k=[],b=et=0;0<=V?et<V:et>V;b=0<=V?++et:--et)k[b]=w[b];for(u=0,U=a,a-=1;U-- >=0;)if(I=i+.5|0,0!==I){for(I>256&&(I=256),g=I+I+1,W=K<<2,Q=K-1,v=m-1,O=I+1,_=O*(O+1)/2,j=new t,H=void 0,N=j,b=it=1;1<=g?it<g:it>g;b=1<=g?++it:--it)N=N.next=new t,b===O&&(H=N);for(N.next=j,J=null,G=null,tt=Z=0,S=r[I],z=s[I],X=rt=0;0<=m?rt<m:rt>m;X=0<=m?++rt:--rt){for(B=d=o=T=f=l=0,L=O*(F=k[Z]),p=O*(P=k[Z+1]),h=O*(M=k[Z+2]),T+=_*F,f+=_*P,l+=_*M,N=j,b=nt=0;0<=O?nt<O:nt>O;b=0<=O?++nt:--nt)N.r=F,N.g=P,N.b=M,N=N.next;for(b=st=1;1<=O?st<O:st>O;b=1<=O?++st:--st)C=Z+((Q<b?Q:b)<<2),T+=(N.r=F=k[C])*(A=O-b),f+=(N.g=P=k[C+1])*A,l+=(N.b=M=k[C+2])*A,B+=F,d+=P,o+=M,N=N.next;for(J=j,G=H,Y=at=0;0<=K?at<K:at>K;Y=0<=K?++at:--at)k[Z]=T*S>>z,k[Z+1]=f*S>>z,k[Z+2]=l*S>>z,T-=L,f-=p,l-=h,L-=J.r,p-=J.g,h-=J.b,C=tt+((C=Y+O)<Q?C:Q)<<2,B+=J.r=k[C],d+=J.g=k[C+1],o+=J.b=k[C+2],T+=B,f+=d,l+=o,J=J.next,L+=F=G.r,p+=P=G.g,h+=M=G.b,B-=F,d-=P,o-=M,G=G.next,Z+=4;tt+=K}for(Y=ot=0;0<=K?ot<K:ot>K;Y=0<=K?++ot:--ot){for(d=o=B=f=l=T=0,Z=Y<<2,L=O*(F=k[Z]),p=O*(P=k[Z+1]),h=O*(M=k[Z+2]),T+=_*F,f+=_*P,l+=_*M,N=j,b=ht=0;0<=O?ht<O:ht>O;b=0<=O?++ht:--ht)N.r=F,N.g=P,N.b=M,N=N.next;for($=K,b=lt=1;1<=O?lt<O:lt>O;b=1<=O?++lt:--lt)Z=$+Y<<2,T+=(N.r=F=k[Z])*(A=O-b),f+=(N.g=P=k[Z+1])*A,l+=(N.b=M=k[Z+2])*A,B+=F,d+=P,o+=M,N=N.next,b<v&&($+=K);for(Z=Y,J=j,G=H,X=ct=0;0<=m?ct<m:ct>m;X=0<=m?++ct:--ct)C=Z<<2,k[C]=T*S>>z,k[C+1]=f*S>>z,k[C+2]=l*S>>z,T-=L,f-=p,l-=h,L-=J.r,p-=J.g,h-=J.b,C=Y+((C=X+O)<v?C:v)*K<<2,T+=B+=J.r=k[C],f+=d+=J.g=k[C+1],l+=o+=J.b=k[C+2],J=J.next,L+=F=G.r,p+=P=G.g,h+=M=G.b,B-=F,d-=P,o-=M,G=G.next,Z+=K}for(i*=n,b=q;--b>-1;)x=b<<2,R=(255&E[x+2])/255*a,D=0|R,D===u?(c=256*(R-(0|R)),y=256-c,w[x]=w[x]*y+k[x]*c>>8,w[x+1]=w[x+1]*y+k[x+1]*c>>8,w[x+2]=w[x+2]*y+k[x+2]*c>>8):D===u+1&&(w[x]=k[x],w[x+1]=k[x+1],w[x+2]=k[x+2]);u++}return this}),n.Filter.register("tiltShift",function(t){var i,r;return i={center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3},t=w.extend(i,t),t.angle*=Math.PI/180,r=e(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,t.angle,t.focusWidth,!0),this.processPlugin("compoundBlur",[r,t.startRadius,t.radiusFactor,t.steps])}),n.Filter.register("radialBlur",function(t){var e,r,n,s;return e={size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null},t=w.extend(e,t),t.radius||(t.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width),n=t.radius/2-t.size,s=t.radius/2,r=i(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,n,s),this.processPlugin("compoundBlur",[r,t.startRadius,t.radiusFactor,t.steps])})}(),n.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0])}),n.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1])}),n.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2])}),n.Filter.register("posterize",function(t){var e,i;return e=256/t,i=255/(t-1),this.process("posterize",function(t){return t.r=Math.floor(Math.floor(t.r/e)*i),t.g=Math.floor(Math.floor(t.g/e)*i),t.b=Math.floor(Math.floor(t.b/e)*i),t})}),n.Filter.register("vintage",function(t){if(null==t&&(t=!0),this.greyscale(),this.contrast(5),this.noise(3),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.87),t)return this.vignette("40%",30)}),n.Filter.register("lomo",function(t){return null==t&&(t=!0),this.brightness(15),this.exposure(15),this.curves("rgb",[0,0],[200,0],[155,255],[255,255]),this.saturation(-20),this.gamma(1.8),t&&this.vignette("50%",60),this.brightness(5)}),n.Filter.register("clarity",function(t){return null==t&&(t=!1),this.vibrance(20),this.curves("rgb",[5,0],[130,150],[190,220],[250,255]),this.sharpen(15),this.vignette("45%",20),t&&(this.greyscale(),this.contrast(4)),this}),n.Filter.register("sinCity",function(){return this.contrast(100),this.brightness(15),this.exposure(10),this.posterize(80),this.clip(30),this.greyscale()}),n.Filter.register("sunrise",function(){return this.exposure(3.5),this.saturation(-5),this.vibrance(50),this.sepia(60),this.colorize("#e87b22",10),this.channels({red:8,blue:8}),this.contrast(5),this.gamma(1.2),this.vignette("55%",25)}),n.Filter.register("crossProcess",function(){return this.exposure(5),this.colorize("#e87b22",4),this.sepia(20),this.channels({blue:8,red:3}),this.curves("b",[0,0],[100,150],[180,180],[255,255]),this.contrast(15),this.vibrance(75),this.gamma(1.6)}),n.Filter.register("orangePeel",function(){return this.curves("rgb",[0,0],[100,50],[140,200],[255,255]),this.vibrance(-30),this.saturation(-30),this.colorize("#ff9000",30),this.contrast(-5),this.gamma(1.4)}),n.Filter.register("love",function(){return this.brightness(5),this.exposure(8),this.contrast(4),this.colorize("#c42007",30),this.vibrance(50),this.gamma(1.3)}),n.Filter.register("grungy",function(){return this.gamma(1.5),this.clip(25),this.saturation(-60),this.contrast(5),this.noise(5),this.vignette("50%",30)}),n.Filter.register("jarques",function(){return this.saturation(-35),this.curves("b",[20,0],[90,120],[186,144],[255,230]),this.curves("r",[0,0],[144,90],[138,120],[255,255]),this.curves("g",[10,0],[115,105],[148,100],[255,248]),this.curves("rgb",[0,0],[120,100],[128,140],[255,255]),this.sharpen(20)}),n.Filter.register("pinhole",function(){return this.greyscale(),this.sepia(10),this.exposure(10),this.contrast(15),this.vignette("60%",35)}),n.Filter.register("oldBoot",function(){return this.saturation(-20),this.vibrance(-50),this.gamma(1.1),this.sepia(30),this.channels({red:-10,blue:5}),this.curves("rgb",[0,0],[80,50],[128,230],[255,255]),this.vignette("60%",30)}),n.Filter.register("glowingSun",function(t){if(null==t&&(t=!0),this.brightness(10),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.gamma(.8),this.filter.contrast(50),this.filter.exposure(10)}),this.newLayer(function(){return this.setBlendingMode("softLight"),this.opacity(80),this.fillColor("#f49600")}),this.exposure(20),this.gamma(.8),t)return this.vignette("45%",20)}),n.Filter.register("hazyDays",function(){return this.gamma(1.2),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(60),this.copyParent(),this.filter.channels({red:5}),this.filter.stackBlur(15)}),this.newLayer(function(){return this.setBlendingMode("addition"),this.opacity(40),this.fillColor("#6899ba")}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(35),this.copyParent(),this.filter.brightness(40),this.filter.vibrance(40),this.filter.exposure(30),this.filter.contrast(15),this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]),this.filter.stackBlur(5)}),this.curves("r",[20,0],[128,158],[128,128],[235,255]),this.curves("g",[20,0],[128,128],[128,128],[235,255]),this.curves("b",[20,0],[128,108],[128,128],[235,255]),this.vignette("45%",20)}),n.Filter.register("herMajesty",function(){return this.brightness(40),this.colorize("#ea1c5d",10),this.curves("b",[0,10],[128,180],[190,190],[255,255]),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(50),this.copyParent(),this.filter.gamma(.7),this.newLayer(function(){return this.setBlendingMode("normal"),this.opacity(60),this.fillColor("#ea1c5d")})}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(60),this.copyParent(),this.filter.saturation(50),this.filter.hue(90),this.filter.contrast(10)}),this.gamma(1.4),this.vibrance(-30),this.newLayer(function(){return this.opacity(10),this.fillColor("#e5f0ff")}),this}),n.Filter.register("nostalgia",function(){return this.saturation(20),this.gamma(1.4),this.greyscale(),this.contrast(5),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.8),this.contrast(5),this.exposure(10),this.newLayer(function(){return this.setBlendingMode("overlay"),this.copyParent(),this.opacity(55),this.filter.stackBlur(10)}),this.vignette("50%",30)}),n.Filter.register("hemingway",function(){return this.greyscale(),this.contrast(10),this.gamma(.9),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(40),this.copyParent(),this.filter.exposure(15),this.filter.contrast(15),this.filter.channels({green:10,red:5})}),this.sepia(30),this.curves("rgb",[0,10],[120,90],[180,200],[235,255]),this.channels({red:5,green:-2}),this.exposure(15)}),n.Filter.register("concentrate",function(){return this.sharpen(40),this.saturation(-50),this.channels({red:3}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.sharpen(5),this.filter.contrast(50),this.filter.exposure(10),this.filter.channels({blue:5})}),this.brightness(10)}),n.Plugin.register("rotate",function(t){var e,i,r,n,s,o,h,l;return e=t%360,0===e?this.dimensions={width:this.canvas.width,height:this.canvas.height}:(s=Math.PI/180,"undefined"!=typeof exports&&null!==exports?i=new a:(i=document.createElement("canvas"),w.copyAttributes(this.canvas,i)),90===e||e===-270||270===e||e===-90?(o=this.canvas.height,n=this.canvas.width,h=o/2,l=n/2):180===e?(o=this.canvas.width,n=this.canvas.height,h=o/2,l=n/2):(o=Math.sqrt(Math.pow(this.originalWidth,2)+Math.pow(this.originalHeight,2)),n=o,h=this.canvas.height/2,l=this.canvas.width/2),i.width=o,i.height=n,r=i.getContext("2d"),r.save(),r.translate(h,l),r.rotate(e*s),r.drawImage(this.canvas,-this.canvas.width/2,-this.canvas.height/2,this.canvas.width,this.canvas.height),r.restore(),this.replaceCanvas(i))}),n.Filter.register("rotate",function(){return this.processPlugin("rotate",Array.prototype.slice.call(arguments,0))}),function(){var t,e,i;return e=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],i=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],t=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},n.Plugin.register("stackBlur",function(r){var n,s,a,o,h,l,c,u,g,d,p,f,m,v,b,y,x,w,D,I,R,S,C,M,P,k,F,B,L,T,E,O,A,z,N,H,J,G,j,U,_,W,q,V,K;if(!(isNaN(r)||r<1)){for(r|=0,b=this.pixelData,T=this.dimensions.width,u=this.dimensions.height,o=r+r+1,L=T<<2,E=T-1,g=u-1,I=r+1,B=I*(I+1)/2,F=new t,C=F,d=J=1;1<=o?J<o:J>o;d=1<=o?++J:--J)C=C.next=new t,d===I&&(M=C);for(C.next=F,P=null,k=null,H=z=0,p=e[r],S=i[r],A=G=0;0<=u?G<u:G>u;A=0<=u?++G:--G){for(x=h=n=D=c=a=0,w=I*(y=b[z]),l=I*(v=b[z+1]),s=I*(m=b[z+2]),D+=B*y,c+=B*v,a+=B*m,C=F,d=j=0;0<=I?j<I:j>I;d=0<=I?++j:--j)C.r=y,C.g=v,C.b=m,C=C.next;for(d=U=1;1<=I?U<I:U>I;d=1<=I?++U:--U)f=z+((E<d?E:d)<<2),D+=(C.r=y=b[f])*(R=I-d),c+=(C.g=v=b[f+1])*R,a+=(C.b=m=b[f+2])*R,x+=y,h+=v,n+=m,C=C.next;for(P=F,k=M,O=_=0;0<=T?_<T:_>T;O=0<=T?++_:--_)b[z]=D*p>>S,b[z+1]=c*p>>S,b[z+2]=a*p>>S,D-=w,c-=l,a-=s,w-=P.r,l-=P.g,s-=P.b,f=H+((f=O+r+1)<E?f:E)<<2,x+=P.r=b[f],h+=P.g=b[f+1],n+=P.b=b[f+2],D+=x,c+=h,a+=n,P=P.next,w+=y=k.r,l+=v=k.g,s+=m=k.b,x-=y,h-=v,n-=m,k=k.next,z+=4;H+=T}for(O=W=0;0<=T?W<T:W>T;O=0<=T?++W:--W){for(h=n=x=c=a=D=0,z=O<<2,w=I*(y=b[z]),l=I*(v=b[z+1]),s=I*(m=b[z+2]),D+=B*y,c+=B*v,a+=B*m,C=F,d=q=0;0<=I?q<I:q>I;d=0<=I?++q:--q)C.r=y,C.g=v,C.b=m,C=C.next;for(N=T,d=V=1;1<=r?V<=r:V>=r;d=1<=r?++V:--V)z=N+O<<2,D+=(C.r=y=b[z])*(R=I-d),c+=(C.g=v=b[z+1])*R,a+=(C.b=m=b[z+2])*R,x+=y,h+=v,n+=m,C=C.next,d<g&&(N+=T);for(z=O,P=F,k=M,A=K=0;0<=u?K<u:K>u;A=0<=u?++K:--K)f=z<<2,b[f]=D*p>>S,b[f+1]=c*p>>S,b[f+2]=a*p>>S,D-=w,c-=l,a-=s,w-=P.r,l-=P.g,s-=P.b,f=O+((f=A+I)<g?f:g)*T<<2,D+=x+=P.r=b[f],c+=h+=P.g=b[f+1],a+=n+=P.b=b[f+2],P=P.next,w+=y=k.r,l+=v=k.g,s+=m=k.b,x-=y,h-=v,n-=m,k=k.next,z+=T}return this}}),n.Filter.register("stackBlur",function(t){return this.processPlugin("stackBlur",[t])})}(),n.Filter.register("threshold",function(t){return this.process("threshold",function(e){var i;return i=.2126*e.r+.7152*e.g+.0722*e.b,i<t?(e.r=0,e.g=0,e.b=0):(e.r=255,e.g=255,e.b=255),e;
})})}.call(this),function(t){"use strict";function e(t,e,i){var r;return function(){var n=this,s=arguments,a=function(){r=null,i||t.apply(n,s)},o=i&&!r;clearTimeout(r),r=setTimeout(a,e),o&&t.apply(n,s)}}function i(t){var e=(window.getComputedStyle?getComputedStyle(t,null):t.currentStyle).display;"none"!==e?t.style.display="none":t.style.display="block"}function r(e){return parseFloat(t.getElement(e).value)}function n(t){var e=[],i=!0;this.filters.map(function(r){e.push(r.processor(t)),r.sync===!1&&(i=!1)}),this.viewer.setFilterOptions({filters:{processors:e},loadMode:i?"sync":"async"})}if(!t.version||t.version.major<2)throw new Error("This version of OpenSeadragonImagefilters requires OpenSeadragon version 2.0.0+");var s=Caman;s.Store.put=function(){},t.Viewer.prototype.imagefilters=function(e){return this.imageFilterInstance&&!e||(e=e||{},e.viewer=this,this.imageFilterInstance=new t.ImagefilterTools(e)),this.imageFilterInstance},t.ImagefilterTools=function(e){t.extend(!0,this,{viewer:null,buttonActiveImg:!1,showControl:!0,startOpen:!1,prefixUrl:null,toolsLeft:null,toolsTop:null,toolsWidth:180,toolsHeight:280,menuId:"osd-imagetools",popUpClass:null,navImages:{imagetools:{REST:"imagetools_rest.png",GROUP:"imagetools_grouphover.png",HOVER:"imagetools_hover.png",DOWN:"imagetools_pressed.png"}},filters:[{filterName:"brightness",min:-255,max:255,callback:null,processor:function(t){var e=r(t+"brightness");return null!==this.callback&&this.callback(e),OpenSeadragon.Filters.BRIGHTNESS(e)}},{filterName:"contrast",min:0,max:5,value:1,defaultValue:1,step:.1,callback:null,processor:function(t){var e=r(t+"contrast");return null!==this.callback&&this.callback(e),OpenSeadragon.Filters.CONTRAST(e)}},{filterName:"thresholding",min:-1,max:255,value:-1,defaultValue:-1,step:1,callback:null,processor:function(t){var e=r(t+"thresholding");return null!==this.callback&&this.callback(e),OpenSeadragon.Filters.THRESHOLDING(e)}},{filterName:"invert",min:0,max:1,value:0,defaultValue:0,step:1,callback:null,processor:function(t){var e=r(t+"invert");return null!==this.callback&&this.callback(e),OpenSeadragon.Filters.INVERT(e)}},{filterName:"gamma",min:0,max:5,value:1,defaultValue:1,step:.05,callback:null,processor:function(t){var e=r(t+"gamma");return null!==this.callback&&this.callback(e),OpenSeadragon.Filters.GAMMA(e)}},{filterName:"greyscale",min:0,max:1,value:0,defaultValue:0,step:1,callback:null,processor:function(t){var e=r(t+"greyscale");return null!==this.callback&&this.callback(e),OpenSeadragon.Filters.GREYSCALE(e)}}],toggleButton:null},e),t.extend(!0,this.navImages,this.viewer.navImages);var i=this.prefixUrl||this.viewer.prefixUrl||"",n=this.viewer.buttons&&this.viewer.buttons.buttons;this.showControl&&(this.toggleButton=new t.Button({element:this.toggleButton?t.getElement(this.toggleButton):null,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,tooltip:t.getString("Tooltips.ImageTools")||"Image tools",srcRest:i+this.navImages.imagetools.REST,srcGroup:i+this.navImages.imagetools.GROUP,srcHover:i+this.navImages.imagetools.HOVER,srcDown:i+this.navImages.imagetools.DOWN,onRelease:this.openTools.bind(this)}),n&&(this.viewer.buttons.buttons.push(this.toggleButton),this.viewer.buttons.element.appendChild(this.toggleButton.element)),this.toggleButton.imgDown&&(this.buttonActiveImg=this.toggleButton.imgDown.cloneNode(!0),this.toggleButton.element.appendChild(this.buttonActiveImg))),this.viewer.addHandler("open",function(){this.createPopupDiv(),this.updateFilters(this.menuId)}.bind(this)),this.startOpen&&this.viewer.addHandler("open",function(){this.openTools()}.bind(this))},t.extend(t.ImagefilterTools.prototype,t.ControlDock.prototype,{createPopupDiv:function(){var e=t.getElement(this.menuId);if(!e){var i=this.toolsWidth,r=this.toolsHeight,n=t.getElement(this.viewer.id),s=n.getBoundingClientRect(),a=this.toolsTop||s.height/2-r/2;a<0&&(a=0);var o=this.toolsLeft||10;e=document.createElement("div"),e.id=this.menuId,this.popUpClass?e["class"]=this.popUpClass:(e.style.display="none",e.style.textAlign="center",e.style.position="relative",e.style.border="1px solid black",e.style.backgroundColor="white",e.style.width=i+"px",e.style.height=r+"px",e.style.top=a+"px",e.style.left=o+"px",e.style.overflow="hidden"),this.viewer.addControl(e,{}),e.style.display="none",this.filters.map(function(i){var r=document.createElement("input");r.type="range",r.min=i.min,r.max=i.max,r.step=i.step||1,r.value=i.value||0,r.id=this.menuId+i.filterName,this.onRangeChange(r);var n=document.createElement("p");n.style.margin="0",n.innerHTML=t.getString("Tool."+i.filterName)||i.filterName,e.appendChild(n),e.appendChild(r)}.bind(this));var h=document.createElement("button");h.innerHTML=t.getString("Tool.reset")||"reset",h.style.display="block",h.style.margin="0 auto",h.style.padding="2px",h.addEventListener("click",function(){this.resetFilters(this.menuId)}.bind(this)),e.appendChild(h)}},openTools:function(){var t=document.getElementById(this.menuId);i(t)},updateFilters:e(n,50),resetFilters:function(e){this.filters.map(function(i){var r=t.getElement(e+i.filterName);r.value=i.defaultValue||0}),this.updateFilters(this.menuId)},onRangeChange:function(t){var e=!0;t.addEventListener("input",function(){e=!1,this.updateFilters(this.menuId)}.bind(this)),t.addEventListener("change",function(){e&&this.updateFilters(this.menuId)}.bind(this))}})}(OpenSeadragon,Caman);
//# sourceMappingURL=openseadragonimagefilter.js.map
